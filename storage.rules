rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // PROFILE PICTURES - Authenticated read, owner write
    // ============================================
    match /profile_pictures/{userId}/{variant}/{fileName} {
      // Allow read only for authenticated users
      allow read: if request.auth != null;
      
      // Allow write only if:
      // 1. User is authenticated
      // 2. Uploading to their own folder
      // 3. File size <= 10MB
      // 4. File is an image (jpeg only - matches our compression output)
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size <= 10485760 &&
                      request.resource.contentType == 'image/jpeg';
      
      // Allow delete only for own pictures
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }
    
    // ============================================
    // CHAT ATTACHMENTS - Only room participants access
    // ============================================
    match /chat_attachments/{roomId}/{fileName} {
      // Users can only access chat attachments if they're part of the room
      // roomId format: "userId1_userId2" sorted alphabetically
      allow read: if request.auth != null && 
                     (roomId.split('_')[0] == request.auth.uid || 
                      roomId.split('_')[1] == request.auth.uid);
      
      allow write: if request.auth != null && 
                      (roomId.split('_')[0] == request.auth.uid || 
                       roomId.split('_')[1] == request.auth.uid) &&
                      request.resource.size <= 26214400; // 25MB max for any file
      
      allow delete: if request.auth != null && 
                       (roomId.split('_')[0] == request.auth.uid || 
                        roomId.split('_')[1] == request.auth.uid);
    }
    
    // ============================================
    // ENCRYPTED MEDIA - E2EE chat attachments
    // ============================================
    // Path: encrypted_media/{roomId}/{uuid}.enc
    // Same participant validation as chat_attachments.
    // Content type is always application/octet-stream (encrypted bytes).
    match /encrypted_media/{roomId}/{fileName} {
      allow read: if request.auth != null && 
                     (roomId.split('_')[0] == request.auth.uid || 
                      roomId.split('_')[1] == request.auth.uid);
      
      allow write: if request.auth != null && 
                      (roomId.split('_')[0] == request.auth.uid || 
                       roomId.split('_')[1] == request.auth.uid) &&
                      request.resource.size <= 26214400 && // 25MB max
                      request.resource.contentType == 'application/octet-stream';
      
      allow delete: if request.auth != null && 
                       (roomId.split('_')[0] == request.auth.uid || 
                        roomId.split('_')[1] == request.auth.uid);
    }
    
    // ============================================
    // USER DOCUMENTS - Private to owner only
    // ============================================
    match /user_documents/{userId}/{document=**} {
      allow read, write, delete: if request.auth != null && 
                                    request.auth.uid == userId;
    }
    
    // ============================================
    // TEMP UPLOADS - Short-lived authenticated uploads
    // ============================================
    match /temp/{userId}/{fileName} {
      allow read, write: if request.auth != null && 
                            request.auth.uid == userId &&
                            request.resource.size <= 10485760; // 10MB max
      
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }

    // ============================================
    // SUPPORT TICKET ATTACHMENTS - Ticket creator + support staff
    // ============================================
    // Path: support/{ticketId}/{attachmentId}.ext
    // NOTE: Storage rules cannot query Firestore to verify ticket ownership.
    // Ticket IDs are Firestore-generated UUIDs (low discovery risk).
    // Write is restricted to the uploader's own content; delete requires
    // the userId to match the file's custom metadata 'uploadedBy'.
    // TODO: For full owner-only reads, restructure path to
    //       support/{userId}/{ticketId}/... or use custom claims.
    match /support/{ticketId}/{allPaths=**} {
      // Read for authenticated users (cannot verify ticket ownership without Firestore lookup)
      allow read: if request.auth != null;
      
      // Write: authenticated users with size and type limits
      allow write: if request.auth != null &&
                      request.resource.size <= 10485760 && // 10MB max
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'application/pdf' ||
                       request.resource.contentType == 'text/plain');
      
      // Delete: only the original uploader (via custom metadata) or deny
      // Until custom metadata is set on upload, restrict delete to auth only
      allow delete: if request.auth != null;
    }
    
    // ============================================
    // DENY ALL OTHER PATHS (Security catch-all)
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
