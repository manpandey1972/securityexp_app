rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ============================================
    // PROFILE PICTURES - Authenticated read, owner write
    // ============================================
    match /profile_pictures/{userId}/{variant}/{fileName} {
      // Allow read only for authenticated users
      allow read: if request.auth != null;
      
      // Allow write only if:
      // 1. User is authenticated
      // 2. Uploading to their own folder
      // 3. File size <= 10MB
      // 4. File is an image (jpeg only - matches our compression output)
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size <= 10485760 &&
                      request.resource.contentType == 'image/jpeg';
      
      // Allow delete only for own pictures
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }
    
    // ============================================
    // CHAT ATTACHMENTS - Only room participants access
    // ============================================
    match /chat_attachments/{roomId}/{fileName} {
      // Users can only access chat attachments if they're part of the room
      // roomId format: "userId1_userId2" sorted alphabetically
      allow read: if request.auth != null && 
                     (roomId.split('_')[0] == request.auth.uid || 
                      roomId.split('_')[1] == request.auth.uid);
      
      allow write: if request.auth != null && 
                      (roomId.split('_')[0] == request.auth.uid || 
                       roomId.split('_')[1] == request.auth.uid) &&
                      request.resource.size <= 26214400; // 25MB max for any file
      
      allow delete: if request.auth != null && 
                       (roomId.split('_')[0] == request.auth.uid || 
                        roomId.split('_')[1] == request.auth.uid);
    }
    
    // ============================================
    // ENCRYPTED MEDIA - E2EE chat attachments
    // ============================================
    // Path: encrypted_media/{roomId}/{uuid}.enc
    // Same participant validation as chat_attachments.
    // Content type is always application/octet-stream (encrypted bytes).
    match /encrypted_media/{roomId}/{fileName} {
      allow read: if request.auth != null && 
                     (roomId.split('_')[0] == request.auth.uid || 
                      roomId.split('_')[1] == request.auth.uid);
      
      allow write: if request.auth != null && 
                      (roomId.split('_')[0] == request.auth.uid || 
                       roomId.split('_')[1] == request.auth.uid) &&
                      request.resource.size <= 26214400 && // 25MB max
                      request.resource.contentType == 'application/octet-stream';
      
      allow delete: if request.auth != null && 
                       (roomId.split('_')[0] == request.auth.uid || 
                        roomId.split('_')[1] == request.auth.uid);
    }
    
    // ============================================
    // USER DOCUMENTS - Private to owner only
    // ============================================
    match /user_documents/{userId}/{document=**} {
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      
      // Write: owner only, max 25MB, restricted to safe content types
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size <= 26214400 && // 25MB max
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'application/pdf' ||
                       request.resource.contentType == 'text/plain' ||
                       request.resource.contentType == 'application/octet-stream');
      
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }
    
    // ============================================
    // TEMP UPLOADS - Short-lived authenticated uploads
    // ============================================
    match /temp/{userId}/{fileName} {
      allow read, write: if request.auth != null && 
                            request.auth.uid == userId &&
                            request.resource.size <= 10485760; // 10MB max
      
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }

    // ============================================
    // SUPPORT TICKET ATTACHMENTS - Ticket creator + support staff
    // ============================================
    // Path: support/{userId}/{ticketId}/{attachmentId}.ext
    // Restructured with userId prefix so Storage rules can enforce ownership
    // without needing a Firestore lookup.
    match /support/{userId}/{ticketId}/{allPaths=**} {
      // Read: owner of the folder OR users with 'support' custom claim
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                      request.auth.token.support == true ||
                      request.auth.token.admin == true);
      
      // Write: only the folder owner, with size and type limits
      allow write: if request.auth != null &&
                      request.auth.uid == userId &&
                      request.resource.size <= 10485760 && // 10MB max
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType == 'application/pdf' ||
                       request.resource.contentType == 'text/plain');
      
      // Delete: only the folder owner
      allow delete: if request.auth != null &&
                       request.auth.uid == userId;
    }
    
    // ============================================
    // DENY ALL OTHER PATHS (Security catch-all)
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
