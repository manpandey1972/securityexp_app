rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user ID
    function getUserId() {
      return request.auth.uid;
    }
    
    // Helper function to check if target user is an expert
    function isExpert() {
      return 'Expert' in resource.data.roles;
    }
    
    // Check if the request is trying to change admin roles in the roles array
    function isChangingAdminRoles() {
      let oldRoles = resource.data.roles;
      let newRoles = request.resource.data.roles;
      let adminRoles = ['Support', 'Admin', 'SuperAdmin'];
      // Check if any admin role was added or removed
      return ('Support' in oldRoles) != ('Support' in newRoles) ||
             ('Admin' in oldRoles) != ('Admin' in newRoles) ||
             ('SuperAdmin' in oldRoles) != ('SuperAdmin' in newRoles);
    }
    
    // Users collection - users can read/write their own profile
    // Reading OTHER users:
    //   - Anyone can read expert profiles (for browsing/booking)
    //   - Experts can read any user profile (to see client info in chat/calls)
    //   - Admins/SuperAdmins can read all
    match /users/{userId} {
      // Read own profile OR read expert profiles OR requester is expert/admin
      allow read: if isAuthenticated() && (
                     getUserId() == userId || 
                     isExpert() ||
                     'Expert' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles ||
                     'Admin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles ||
                     'SuperAdmin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles
                   );
      
      // Write own profile (but not admin roles in array unless super_admin)
      // Super admins can update any user's admin roles
      allow write: if isAuthenticated() && (
                      // Own profile - allow create OR update if not changing admin roles
                      (getUserId() == userId && (
                        resource == null || // Document doesn't exist yet (creation)
                        !isChangingAdminRoles() // Document exists (update), not changing admin roles
                      )) ||
                      // Super admin can change anyone's admin roles
                      'SuperAdmin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles
                    );
      
      // Note: User document deletion is handled by the deleteAccount Cloud Function
      // (Admin SDK bypasses rules). No client-side delete permission needed.
      
      // User's rooms subcollection - stores unread count per room
      // Note: roomId format is "userId1_userId2" but security is enforced by
      // the parent {userId} path, not the roomId. Users can only access their own subcollection.
      match /rooms/{roomId} {
        allow read: if isAuthenticated() && getUserId() == userId;
        
        // write includes create, update, and delete
        allow write: if isAuthenticated() && getUserId() == userId;
      }
      
      // Incoming calls - real-time notifications for callee
      match /incoming_calls/{callId} {
        // Allow read if user is reading their own incoming calls
        allow read: if isAuthenticated() && getUserId() == userId;
        
        // Allow create by Cloud Functions (admin SDK bypasses rules)
        // Client-side write not needed (Cloud Function handles it)
        allow create: if false;
        
        // Allow delete if user is dismissing the call
        allow delete: if isAuthenticated() && getUserId() == userId;
        
        // Allow update if user is accepting/rejecting the call
        allow update: if isAuthenticated() && getUserId() == userId;
      }
      
      // Call history - permanent record of calls
      match /call_history/{callId} {
        // Allow read if user is reading their own call history
        allow read: if isAuthenticated() && getUserId() == userId;
        
        // Allow create by Cloud Functions (admin SDK bypasses rules)
        allow create: if false;
        
        // Allow delete if user is deleting their own call history
        allow delete: if isAuthenticated() && getUserId() == userId;
        
        // No update - call history records are immutable
        allow update: if false;
      }
      
      // Photo backups - tracks backed-up assets, private to owner
      match /photo_backups/{assetId} {
        // Only the owner can read their backup records
        allow read: if isAuthenticated() && getUserId() == userId;
        
        // Only the owner can create/update backup records
        allow write: if isAuthenticated() && getUserId() == userId;
        
        // Only the owner can delete backup records
        allow delete: if isAuthenticated() && getUserId() == userId;
      }
    }
    
    // ========================================
    // CHAT FUNCTIONALITY
    // ========================================
    
    // Chat rooms - participants can read/write
    match /chat_rooms/{roomId} {
      // Allow read if user is a participant OR if the document doesn't exist (for getOrCreate pattern)
      allow read: if isAuthenticated() && 
                     (!exists(/databases/$(database)/documents/chat_rooms/$(roomId)) ||
                      getUserId() in resource.data.participants);
      
      // Allow create if user is one of the participants (exactly 2, user must be one of them)
      allow create: if isAuthenticated() && 
                       getUserId() in request.resource.data.participants &&
                       request.resource.data.participants.size() == 2 &&
                       request.resource.data.participants[0] != request.resource.data.participants[1];
      
      // Allow update if user is a participant (for lastMessage, lastMessageTime)
      allow update: if isAuthenticated() && 
                       getUserId() in resource.data.participants;
      
      // Allow delete if user is a participant
      allow delete: if isAuthenticated() && 
                       getUserId() in resource.data.participants;
    
      // Messages subcollection - users can read/write their own messages
      match /messages/{messageId} {
        // Allow read if user is a room participant
        allow read: if isAuthenticated() && 
                       getUserId() in get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.participants;
        
        // Allow create if user is the sender and is a room participant
        allow create: if isAuthenticated() && 
                         request.resource.data.sender_id == getUserId() &&
                         getUserId() in get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.participants;
        
        // Allow delete if user is a room participant (for clearing/deleting chat)
        allow delete: if isAuthenticated() && 
                         getUserId() in get(/databases/$(database)/documents/chat_rooms/$(roomId)).data.participants;
        
        // Allow update for message sender (future features like edits, reactions)
        allow update: if isAuthenticated() && 
                         resource.data.sender_id == getUserId();
      }
    }
    
    // ========================================
    // ========================================
    // CALLING - LiveKit Room Access Control
    // ========================================
    // NOTE: Legacy active_calls collection (WebRTC) has been removed.
    // All call signaling now uses livekit_rooms collection below.
    // NOTE: Top-level call_history collection is also removed.
    // Call history is now stored as subcollection: users/{userId}/call_history/{callId}

    // ========================================
    // LIVEKIT ROOM ACCESS CONTROL
    // ========================================
    
    // LiveKit rooms - metadata for access control and call management
    match /livekit_rooms/{roomId} {
      // Allow read if user is a participant (caller or callee) or if reading their own incoming calls
      allow read: if isAuthenticated() && 
                     (getUserId() == resource.data.caller_id || 
                      getUserId() == resource.data.callee_id);
      
      // Allow create if user is the caller (creating a new call room)
      allow create: if isAuthenticated() && 
                       getUserId() == request.resource.data.caller_id &&
                       request.resource.data.callee_id != null &&
                       request.resource.data.status == 'pending';
      
      // Allow update if user is a participant (status changes, room updates)
      allow update: if isAuthenticated() && 
                       (getUserId() == resource.data.caller_id || 
                        getUserId() == resource.data.callee_id);
      
      // Allow delete by participants (cleanup after call)
      allow delete: if isAuthenticated() && 
                       (getUserId() == resource.data.caller_id || 
                        getUserId() == resource.data.callee_id);
      
      // NOTE: Legacy ice_candidates subcollection removed.
      // LiveKit handles ICE negotiation internally through its SFU server.
    }
    
    // ========================================
    // ADMIN HELPER FUNCTIONS
    // ========================================
    
    // Get user's roles array from their document
    function getUserRoles() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    // Check if user is admin (Admin or SuperAdmin in roles array)
    function isAdmin() {
      let roles = getUserRoles();
      return isAuthenticated() && ('Admin' in roles || 'SuperAdmin' in roles);
    }
    
    // Check if user is support or higher (Support, Admin, or SuperAdmin in roles array)
    function isSupport() {
      let roles = getUserRoles();
      return isAuthenticated() && ('Support' in roles || 'Admin' in roles || 'SuperAdmin' in roles);
    }
    
    // Check if user is super admin
    function isSuperAdmin() {
      return isAuthenticated() && 'SuperAdmin' in getUserRoles();
    }
    
    // ========================================
    // ADDITIONAL COLLECTIONS
    // ========================================
    
    // Skills collection - read for authenticated, write for admins
    match /skills/{skillId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Products - read-only for authenticated users
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow write: if false; // Products managed by backend/admin only
    }
    
    // ========================================
    // FAQ MANAGEMENT
    // ========================================
    
    // FAQs - public read, admin write
    match /faqs/{faqId} {
      allow read: if true;  // Public read for help content
      allow write: if isAdmin();
    }
    
    // FAQ Categories - public read, admin write
    match /faq_categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // FAQ Feedback - authenticated users can submit
    match /faq_feedback/{feedbackId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ========================================
    // SUPPORT TICKETS
    // ========================================
    
    // Support tickets - users read own, admins read all
    match /support_tickets/{ticketId} {
      // Users can read their own tickets, support/admin can read all
      allow read: if isAuthenticated() && (
                     resource.data.userId == getUserId() ||
                     isSupport()
                   );
      
      // Authenticated users can create tickets with their own userId
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == getUserId();
      
      // Users can update their own tickets, support/admin can update any
      allow update: if isAuthenticated() && (
                       resource.data.userId == getUserId() ||
                       isSupport()
                     );
      
      // No direct delete - tickets are archived, not deleted
      allow delete: if false;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Users can read messages on their own tickets, support/admin can read all
        allow read: if isAuthenticated() && (
                       get(/databases/$(database)/documents/support_tickets/$(ticketId)).data.userId == getUserId() ||
                       isSupport()
                     );
        
        // Users can create messages on their own tickets, support/admin can create on any
        allow create: if isAuthenticated() && (
                         get(/databases/$(database)/documents/support_tickets/$(ticketId)).data.userId == getUserId() ||
                         isSupport()
                       );
        
        // Users can update messages on their own tickets
        allow update: if isAuthenticated() &&
                         get(/databases/$(database)/documents/support_tickets/$(ticketId)).data.userId == getUserId();
        
        allow delete: if false;
      }
      
      // Internal notes - support/admin only (not visible to users)
      match /internal_notes/{noteId} {
        allow read, write: if isSupport();
      }
    }
    
    // Support counters - only Cloud Functions (admin SDK)
    match /support_counters/{counterId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // Support analytics - only Cloud Functions (admin SDK)
    match /support_analytics/{periodId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ========================================
    // EXPERT RATINGS
    // ========================================
    
    // Ratings - authenticated users can read and create ratings for experts
    match /ratings/{ratingId} {
      // Authenticated users can read ratings (for display on expert profiles)
      allow read: if isAuthenticated();
      
      // Authenticated users can create ratings:
      // - Must be their own userId (no impersonation)
      // - Must have valid stars (1-5)
      // - Cannot rate themselves (expertId != userId)
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == getUserId() &&
                       request.resource.data.expertId != getUserId() &&
                       request.resource.data.stars >= 1 &&
                       request.resource.data.stars <= 5;
      
      // No update allowed - ratings are immutable
      allow update: if false;
      
      // No delete allowed - ratings are permanent
      allow delete: if false;
    }
    
    // ========================================
    // ADMIN AUDIT LOGS
    // ========================================
    
    // Audit logs - super admin read only, created via Cloud Functions
    match /admin_audit_logs/{logId} {
      allow read: if isSuperAdmin();
      allow create: if isAdmin();  // Created via cloud function
      allow update, delete: if false;
    }
    
    // ========================================
    // Account Deletion Requests
    // ========================================
    
    // Users can create their own deletion request to trigger background cleanup.
    // The Cloud Function updates the document with status â€” no client updates needed.
    match /deletion_requests/{userId} {
      allow create: if isAuthenticated() && getUserId() == userId;
      allow read: if false;   // No client reads needed
      allow update: if false; // Only Cloud Function (Admin SDK) updates
      allow delete: if false; // Retained for audit trail
    }

    // ========================================
    // Default rule - deny all other access
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
